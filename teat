-- ðŸŽ¯ FOV SILENT AIM - MIT HUB INTEGRATION

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

-- === HUB VERBINDUNG ===
getgenv().SchmecktHubPC = getgenv().SchmecktHubPC or {}
local Shared = getgenv().SchmecktHubPC

-- PrÃ¼fen ob bereits geladen
if Shared._SilentAimFOVLoaded then return end
Shared._SilentAimFOVLoaded = true

-- === SETTINGS ===
local FOV_RADIUS = 150 -- Pixel vom Bildschirm-Zentrum

-- === STATUS ===
local targetPart = nil
local predictionPos = nil

-- === FOV CIRCLE ===
local fovCircle = Drawing.new("Circle")
fovCircle.Thickness = 2
fovCircle.Color = Color3.fromRGB(255, 0, 0)
fovCircle.Filled = false
fovCircle.Transparency = 0.8
fovCircle.Radius = FOV_RADIUS
fovCircle.Visible = false

-- === FUNKTIONEN ===

-- RICHTIGE PRÃœFUNG: SilentAim AN + Methode ist FOV
local function isEnabled()
    return Shared.SilentAim == true and Shared.SilentAimMethod == "FOV"
end

local function getClosestInFOV()
    local bestDist = FOV_RADIUS
    local bestTarget = nil
    local screenCenter = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            local char = plr.Character
            local hum = char:FindFirstChild("Humanoid")
            local head = char:FindFirstChild("Head")
            
            if hum and hum.Health > 0 and head then
                local pos, onScreen = Camera:WorldToViewportPoint(head.Position)
                if onScreen then
                    local dist = (Vector2.new(pos.X, pos.Y) - screenCenter).Magnitude
                    if dist < bestDist then
                        bestDist = dist
                        bestTarget = head
                    end
                end
            end
        end
    end
    return bestTarget
end

local function getPrediction(part)
    if not part then return nil end
    local char = part.Parent
    if not char then return part.Position end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return part.Position end

    local vel = hrp.AssemblyLinearVelocity or Vector3.zero
    
    local ping = 0.06
    pcall(function() ping = LocalPlayer:GetNetworkPing() end)
    
    local dist = (part.Position - Camera.CFrame.Position).Magnitude
    local timeToHit = (dist / 1000) + ping
    
    return part.Position + (vel * timeToHit)
end

-- Update Loop
local renderConnection
renderConnection = RunService.RenderStepped:Connect(function()
    local screenCenter = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    fovCircle.Position = screenCenter
    
    if not isEnabled() then
        fovCircle.Visible = false
        targetPart = nil
        predictionPos = nil
        return
    end
    
    fovCircle.Visible = true
    
    targetPart = getClosestInFOV()
    if targetPart then
        predictionPos = getPrediction(targetPart)
    else
        predictionPos = nil
    end
end)

-- === HOOKS ===
local mt = getrawmetatable(game)
local oldNc = mt.__namecall
local oldIdx = mt.__index
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
    local m = getnamecallmethod()
    local a = {...}
    
    -- NUR wenn aktiviert UND FOV-Method
    if isEnabled() and predictionPos then
        if m == "Raycast" and self == Workspace then
            if a[1] and a[2] then
                a[2] = (predictionPos - a[1]).Unit * a[2].Magnitude
                return oldNc(self, unpack(a))
            end
        end
        if self == Mouse and (m == "GetHit" or m == "Hit") then
            return CFrame.new(predictionPos)
        end
    end
    return oldNc(self, ...)
end)

mt.__index = newcclosure(function(self, k)
    if isEnabled() and predictionPos and self == Mouse then
        if k == "Hit" then return CFrame.new(predictionPos) end
        if k == "Target" then return targetPart end
    end
    return oldIdx(self, k)
end)

setreadonly(mt, true)

-- Cleanup
local hubGui = game:GetService("CoreGui"):FindFirstChild("SchmecktHub")
if hubGui then
    hubGui.AncestryChanged:Connect(function(_, parent)
        if not parent then
            if renderConnection then renderConnection:Disconnect() end
            fovCircle:Remove()
            Shared._SilentAimFOVLoaded = nil
        end
    end)
end

print("[SchmecktHub] FOV Silent Aim loaded")
